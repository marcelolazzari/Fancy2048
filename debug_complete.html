<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Debug - Fancy2048</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #f2f2f2;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #ffcc00;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .pass { background: rgba(76, 175, 80, 0.2); border-left: 3px solid #4CAF50; }
        .fail { background: rgba(244, 67, 54, 0.2); border-left: 3px solid #f44336; }
        .warning { background: rgba(255, 152, 0, 0.2); border-left: 3px solid #ff9800; }
        .info { background: rgba(33, 150, 243, 0.2); border-left: 3px solid #2196F3; }
        
        button {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #e6b800; }
        
        .code-block {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #333;
        }
        
        #results {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            background: #1e1e1e;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Complete Debug Analysis - Fancy2048</h1>
    
    <div class="test-section">
        <h2>ğŸ¯ Test Controls</h2>
        <button onclick="runAllTests()">ğŸ”„ Run All Tests</button>
        <button onclick="testDOMStructure()">ğŸ“‹ Test DOM</button>
        <button onclick="testScriptLoading()">ğŸ“¦ Test Scripts</button>
        <button onclick="testGameInitialization()">ğŸ® Test Game Init</button>
        <button onclick="testAISystems()">ğŸ¤– Test AI Systems</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
        <button onclick="exportResults()">ğŸ’¾ Export Results</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š Test Results</h2>
        <div id="results"></div>
    </div>

    <!-- Hidden DOM elements needed for game -->
    <div style="display: none;">
        <div id="board-container"></div>
        <span id="score">0</span>
        <span id="best-score">0</span>
        <span id="moves">0</span>
        <span id="time">00:00</span>
        <button id="changeColor-button"></button>
        <button id="leaderboard-button"></button>
        <button id="export-stats-button"></button>
        <button id="back-button"></button>
        <button id="pause-button"></button>
        <button id="board-size-button"></button>
        <button id="theme-toggle-button"></button>
        <button id="autoplay-button"></button>
        <button id="speed-button"><span class="speed-text">1x</span></button>
        <button id="reset-button"></button>
        <button id="ai-difficulty-button"><span class="button-text">Normal</span></button>
    </div>

    <script>
        let testResults = [];
        
        function addResult(message, type = 'info', details = null) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({ timestamp, message, type, details });
            
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            
            let content = `[${timestamp}] ${message}`;
            if (details) {
                content += `\n<div class="code-block">${JSON.stringify(details, null, 2)}</div>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }
        
        function exportResults() {
            const blob = new Blob([JSON.stringify(testResults, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fancy2048-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function testDOMStructure() {
            addResult('ğŸ” Testing DOM Structure...', 'info');
            
            const requiredElements = [
                'board-container', 'score', 'best-score', 'moves', 'time',
                'changeColor-button', 'leaderboard-button', 'export-stats-button',
                'back-button', 'pause-button', 'board-size-button', 
                'theme-toggle-button', 'autoplay-button', 'speed-button', 
                'reset-button', 'ai-difficulty-button'
            ];
            
            const missingElements = [];
            const foundElements = [];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    foundElements.push(id);
                } else {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length === 0) {
                addResult('âœ… All required DOM elements found', 'pass', {
                    foundElements: foundElements.length,
                    total: requiredElements.length
                });
            } else {
                addResult('âŒ Missing DOM elements', 'fail', {
                    missing: missingElements,
                    found: foundElements.length,
                    total: requiredElements.length
                });
            }
            
            // Test CSS loading
            const boardContainer = document.getElementById('board-container');
            const computedStyle = window.getComputedStyle(boardContainer);
            const hasCSS = computedStyle.display !== 'inline';
            
            if (hasCSS) {
                addResult('âœ… CSS appears to be loaded', 'pass');
            } else {
                addResult('âš ï¸ CSS may not be loaded properly', 'warning');
            }
        }
        
        function testScriptLoading() {
            addResult('ğŸ” Testing Script Loading...', 'info');
            
            const expectedGlobals = [
                { name: 'Game', type: 'function' },
                { name: 'Enhanced2048AI', type: 'function' },
                { name: 'AdvancedAI2048Solver', type: 'function' },
                { name: 'AILearningSystem', type: 'function' }
            ];
            
            const scriptStatus = [];
            
            expectedGlobals.forEach(global => {
                const exists = window[global.name] !== undefined;
                const correctType = exists && typeof window[global.name] === global.type;
                
                scriptStatus.push({
                    name: global.name,
                    exists,
                    correctType,
                    actualType: typeof window[global.name]
                });
                
                if (exists && correctType) {
                    addResult(`âœ… ${global.name} loaded correctly`, 'pass');
                } else if (exists) {
                    addResult(`âš ï¸ ${global.name} exists but wrong type`, 'warning', {
                        expected: global.type,
                        actual: typeof window[global.name]
                    });
                } else {
                    addResult(`âŒ ${global.name} not found`, 'fail');
                }
            });
        }
        
        function testGameInitialization() {
            addResult('ğŸ” Testing Game Initialization...', 'info');
            
            try {
                if (typeof Game === 'undefined') {
                    addResult('âŒ Game class not available', 'fail');
                    return;
                }
                
                // Clear any existing game instance
                if (window.game) {
                    addResult('â„¹ï¸ Clearing existing game instance', 'info');
                    window.game = null;
                }
                
                // Try to create a new game instance
                addResult('ğŸ® Creating new Game instance...', 'info');
                const testGame = new Game(4);
                
                if (testGame) {
                    addResult('âœ… Game instance created successfully', 'pass');
                    
                    // Test basic game properties
                    const properties = ['size', 'board', 'score', 'moves', 'gameState'];
                    properties.forEach(prop => {
                        if (testGame.hasOwnProperty(prop)) {
                            addResult(`âœ… Property ${prop} exists: ${testGame[prop]}`, 'pass');
                        } else {
                            addResult(`âŒ Missing property: ${prop}`, 'fail');
                        }
                    });
                    
                    // Test AI integration
                    if (testGame.enhancedAI) {
                        addResult('âœ… Enhanced AI integrated', 'pass');
                    } else {
                        addResult('âš ï¸ Enhanced AI not integrated', 'warning');
                    }
                    
                    if (testGame.aiLearningSystem) {
                        addResult('âœ… AI Learning System integrated', 'pass');
                    } else {
                        addResult('âš ï¸ AI Learning System not integrated', 'warning');
                    }
                    
                    window.testGame = testGame;
                    
                } else {
                    addResult('âŒ Failed to create Game instance', 'fail');
                }
                
            } catch (error) {
                addResult('âŒ Game initialization failed', 'fail', {
                    error: error.message,
                    stack: error.stack
                });
            }
        }
        
        function testAISystems() {
            addResult('ğŸ” Testing AI Systems...', 'info');
            
            if (!window.testGame) {
                addResult('âš ï¸ No test game instance available, creating one...', 'warning');
                testGameInitialization();
            }
            
            if (window.testGame) {
                try {
                    // Test Enhanced AI
                    if (window.testGame.enhancedAI && typeof window.testGame.enhancedAI.getBestMove === 'function') {
                        addResult('ğŸ§  Testing Enhanced AI move generation...', 'info');
                        const move = window.testGame.enhancedAI.getBestMove();
                        if (move && ['up', 'down', 'left', 'right'].includes(move)) {
                            addResult(`âœ… Enhanced AI generated move: ${move}`, 'pass');
                        } else {
                            addResult('âš ï¸ Enhanced AI returned invalid move', 'warning', { move });
                        }
                    } else {
                        addResult('âŒ Enhanced AI not available or missing getBestMove method', 'fail');
                    }
                    
                    // Test game move methods
                    const moveMethods = ['canMove', 'move'];
                    moveMethods.forEach(method => {
                        if (typeof window.testGame[method] === 'function') {
                            addResult(`âœ… Game method ${method} available`, 'pass');
                        } else {
                            addResult(`âŒ Game method ${method} missing`, 'fail');
                        }
                    });
                    
                    // Test a simple move if possible
                    if (typeof window.testGame.canMove === 'function' && typeof window.testGame.move === 'function') {
                        const testMove = 'up';
                        const canMove = window.testGame.canMove(testMove);
                        addResult(`â„¹ï¸ Can move ${testMove}: ${canMove}`, 'info');
                        
                        if (canMove) {
                            addResult('ğŸ® Attempting test move...', 'info');
                            try {
                                window.testGame.move(testMove);
                                addResult('âœ… Test move executed successfully', 'pass');
                            } catch (error) {
                                addResult('âŒ Test move failed', 'fail', { error: error.message });
                            }
                        }
                    }
                    
                } catch (error) {
                    addResult('âŒ AI system testing failed', 'fail', {
                        error: error.message,
                        stack: error.stack
                    });
                }
            }
        }
        
        async function runAllTests() {
            addResult('ğŸš€ Starting Complete Debug Analysis...', 'info');
            clearResults();
            
            testDOMStructure();
            
            // Load scripts first
            await loadAllScripts();
            
            testScriptLoading();
            testGameInitialization();
            testAISystems();
            
            addResult('ğŸ All tests completed', 'info');
        }
        
        async function loadAllScripts() {
            addResult('ğŸ“¦ Loading game scripts...', 'info');
            
            const scripts = [
                '../scripts/ai_learning_system.js',
                '../scripts/advanced_ai_solver.js', 
                '../scripts/enhanced_ai.js',
                '../scripts/game.js'
            ];
            
            for (const src of scripts) {
                try {
                    await loadScript(src);
                    addResult(`âœ… Loaded: ${src}`, 'pass');
                } catch (error) {
                    addResult(`âŒ Failed to load: ${src}`, 'fail', { error: error.message });
                }
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script is already loaded
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
        
        // Global error handler
        window.addEventListener('error', (event) => {
            addResult('ğŸš¨ Global JavaScript Error', 'fail', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error ? event.error.toString() : 'Unknown error'
            });
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            addResult('ğŸš¨ Unhandled Promise Rejection', 'fail', {
                reason: event.reason ? event.reason.toString() : 'Unknown reason'
            });
        });
    </script>
</body>
</html>
