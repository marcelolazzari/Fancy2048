<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="apple-mobile-web-app-title" content="Fancy2048" />
    <title>Fancy 2048</title>
    <meta name="description" content="Play Fancy 2048, a modern twist on the classic puzzle game. Track your stats and compete on the leaderboard!" />
    
    <!-- Unified Complete CSS -->
    <link rel="stylesheet" href="../styles/unified_styles_complete.css" />
    <!-- Fallback CSS for GitHub Pages -->
    <link rel="stylesheet" href="/Fancy2048/styles/unified_styles_complete.css" onerror="this.onerror=null;this.href='styles/unified_styles_complete.css';" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <!-- Critical CSS inline for instant loading -->
    <style>
      /* Critical styles to prevent FOUC */
      :root {
        --size: 4;
        --board-bg: #2c2c2c;
        --tile-bg: #3d3d3d;
        --accent-color: #ffcc00;
        --bg-primary: #1a1a1a;
        --text-primary: #f2f2f2;
      }
      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }
      #board-container {
        display: grid !important;
        grid-gap: 10px !important;
        margin: 20px auto !important;
        background: var(--board-bg) !important;
        padding: 20px !important;
        border-radius: 16px !important;
        aspect-ratio: 1 !important;
        max-width: min(90vw, 90vh, 500px) !important;
        grid-template-columns: repeat(4, 1fr) !important;
        grid-template-rows: repeat(4, 1fr) !important;
      }
      .tile {
        background: var(--tile-bg) !important;
        color: white !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: bold !important;
        border-radius: 8px !important;
        font-size: 1.5rem !important;
        min-height: 60px !important;
      }
      .game-title { color: var(--accent-color); text-align: center; }
      button { 
        background: var(--tile-bg); 
        color: var(--text-primary); 
        border: 1px solid #555; 
        padding: 10px 15px; 
        margin: 5px; 
        border-radius: 8px; 
        cursor: pointer; 
      }
      #score-container { 
        text-align: center; 
        margin: 20px; 
        background: var(--board-bg);
        padding: 15px;
        border-radius: 12px;
      }
      #score-container ul { 
        list-style: none; 
        padding: 0; 
        display: flex; 
        justify-content: center; 
        gap: 20px; 
        margin: 0;
      }
    </style>
  </head>
  <body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header section -->
    <header>
      <div class="container">
        <h1 class="game-title" tabindex="0">Fancy 2048</h1>
        <nav aria-label="Game controls">
          <ul id="controls-container" class="controls" role="menubar">
            <li role="none">
              <button type="button" id="changeColor-button" aria-label="Change Color" tabindex="0" role="menuitem" data-tooltip="Change game colors">
                <i class="fas fa-palette" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="leaderboard-button" aria-label="View Statistics" onclick="window.location.href='leaderboard.html'" tabindex="0" role="menuitem" data-tooltip="View statistics and leaderboard">
                <i class="fas fa-chart-line" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="back-button" aria-label="Undo Move" tabindex="0" role="menuitem" data-tooltip="Undo last move">
                <i class="fas fa-undo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="pause-button" aria-label="Pause Game" tabindex="0" role="menuitem" data-tooltip="Pause/Resume game">
                <i class="fas fa-pause" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="board-size-button" aria-label="Change Board Size" tabindex="0" role="menuitem" data-tooltip="Change board size">
                <i class="fas fa-th" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="theme-toggle-button" aria-label="Toggle Theme" tabindex="0" role="menuitem" data-tooltip="Toggle light/dark theme">
                <i class="fas fa-adjust" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="autoplay-button" aria-label="Auto Play" tabindex="0" role="menuitem" data-tooltip="Start/Stop auto play">
                <i class="fas fa-play" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="speed-button" aria-label="Autoplay Speed" tabindex="0" role="menuitem" data-tooltip="Change autoplay speed">
                <span class="speed-text">1x</span>
              </button>
            </li>
            <li role="none">
              <button type="button" id="reset-button" aria-label="Reset Game" tabindex="0" role="menuitem" data-tooltip="Start a new game">
                <i class="fas fa-redo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="ai-difficulty-button" aria-label="Change AI Difficulty" tabindex="0" role="menuitem" data-tooltip="Change AI difficulty level">
                <i class="fas fa-brain" aria-hidden="true"></i>
                <span class="button-text">Normal</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main content section -->
    <main id="main-content">
      <div class="overlay" aria-hidden="true"></div>
      <section class="game-section">
        <div id="board-container" class="board-container" role="grid" aria-label="Game Board" tabindex="0"></div>
        <div id="game-over" class="hidden" role="alert" aria-live="assertive">Game Over!</div>
      </section>

      <aside id="score-container" aria-labelledby="score-title">
        <h2 id="score-title" class="visually-hidden">Score Information</h2>
        <ul>
          <li>Score: <span id="score">0</span></li>
          <li>Best: <span id="best-score">0</span></li>
          <li>Moves: <span id="moves">0</span></li>
          <li>Time: <span id="time">00:00</span></li>
        </ul>
      </aside>
    </main>

    <!-- Footer section -->
    <footer>
      <div class="container">
        <p style="text-align: center; margin: 20px 0; color: #999; font-size: 14px;">
          Use arrow keys or swipe to play. Press P to pause, R to reset.
        </p>
      </div>
    </footer>

    <!-- JavaScript initialization -->
    <script>
      // Pre-initialization setup
      console.log('üöÄ Fancy2048 - Starting initialization...');
      
      // Global error handlers
      window.addEventListener('error', (event) => {
        console.error('üö® Global error:', event.error);
        console.error('File:', event.filename, 'Line:', event.lineno, 'Column:', event.colno);
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        console.error('üö® Unhandled promise rejection:', event.reason);
      });
      
      // DOM elements check
      function checkRequiredElements() {
        const required = ['board-container', 'score', 'best-score', 'moves', 'time'];
        const missing = required.filter(id => !document.getElementById(id));
        
        if (missing.length > 0) {
          console.warn('‚ùå Missing elements:', missing);
          return false;
        }
        
        console.log('‚úÖ All required elements found');
        return true;
      }
      
      // Enhanced script loading with error handling
      function loadScriptWithFallback(src, fallback, name) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          
          script.onload = () => {
            console.log(`‚úÖ Loaded ${name} from: ${src}`);
            resolve();
          };
          
          script.onerror = () => {
            if (fallback) {
              console.warn(`‚ö†Ô∏è Failed to load ${name} from ${src}, trying fallback...`);
              const fallbackScript = document.createElement('script');
              fallbackScript.src = fallback;
              fallbackScript.async = true;
              
              fallbackScript.onload = () => {
                console.log(`‚úÖ Loaded ${name} from fallback: ${fallback}`);
                resolve();
              };
              
              fallbackScript.onerror = () => {
                console.error(`‚ùå Failed to load ${name} from both sources`);
                reject(new Error(`Failed to load ${name}`));
              };
              
              document.head.appendChild(fallbackScript);
            } else {
              console.error(`‚ùå Failed to load ${name}`);
              reject(new Error(`Failed to load ${name}`));
            }
          };
          
          document.head.appendChild(script);
        });
      }
      
      // Main initialization function
      async function initializeGame() {
        try {
          console.log('üìã Checking DOM elements...');
          if (!checkRequiredElements()) {
            throw new Error('Required DOM elements missing');
          }
          
          console.log('üì¶ Loading scripts...');
          
          // Load scripts sequentially
          await loadScriptWithFallback(
            '../scripts/advanced_ai_solver.js',
            '/Fancy2048/scripts/advanced_ai_solver.js',
            'Advanced AI Solver'
          );
          
          await loadScriptWithFallback(
            '../scripts/enhanced_ai.js',
            '/Fancy2048/scripts/enhanced_ai.js',
            'Enhanced AI'
          );
          
          await loadScriptWithFallback(
            '../scripts/game_unified.js',
            '/Fancy2048/scripts/game_unified.js',
            'Game Engine'
          );
          
          console.log('üéÆ All scripts loaded, game should initialize automatically...');
          
        } catch (error) {
          console.error('‚ùå Game initialization failed:', error);
          showErrorMessage(error);
        }
      }
      
      // Error message display
      function showErrorMessage(error) {
        const boardContainer = document.getElementById('board-container');
        if (boardContainer) {
          boardContainer.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              text-align: center;
              padding: 20px;
              color: #ff6b6b;
              background: rgba(244, 67, 54, 0.1);
              border: 2px solid #ff6b6b;
              border-radius: 12px;
            ">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h3 style="margin: 0 0 15px 0; color: #ff6b6b;">Game Loading Error</h3>
              <p style="margin: 0 0 20px 0; line-height: 1.5;">
                Failed to initialize the game. This might be due to network issues or script loading problems.
              </p>
              <button onclick="location.reload()" style="
                padding: 12px 24px;
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                font-size: 16px;
              ">
                <i class="fas fa-redo"></i> Refresh Page
              </button>
            </div>
          `;
        }
        
        // Also show a toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(244, 67, 54, 0.95);
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          font-weight: bold;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        toast.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-exclamation-circle"></i>
            <span>Game Loading Failed - Please refresh</span>
          </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }
      
      // Start initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGame);
      } else {
        // DOM already loaded
        setTimeout(initializeGame, 50);
      }
      
      // Additional safety net
      window.addEventListener('load', () => {
        if (!window.game) {
          console.log('üö® Game not initialized after window load, attempting recovery...');
          setTimeout(initializeGame, 100);
        }
      });
    </script>
  </body>
</html>
