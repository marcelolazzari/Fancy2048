<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fancy 2048 - Fixed Version</title>
    <link rel="stylesheet" href="../styles/unified_styles_fixed.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Critical CSS to ensure basic functionality -->
    <style>
        /* Critical styles to prevent layout issues */
        :root {
            --size: 4;
            --tile-size: 1fr;
            --gap: 10px;
            --board-bg: #333;
            --tile-bg: #666;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #f2f2f2;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        #board-container {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            grid-template-rows: repeat(4, 1fr) !important;
            grid-gap: 10px !important;
            margin: 20px auto !important;
            background: #333 !important;
            padding: 20px !important;
            border-radius: 10px !important;
            aspect-ratio: 1 !important;
            max-width: min(90vw, 90vh, 500px) !important;
            position: relative !important;
        }
        
        .grid-cell {
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 5px !important;
            position: relative !important;
        }
        
        .tile {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: #666 !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: bold !important;
            border-radius: 5px !important;
            font-size: 1.5rem !important;
            transition: all 0.15s ease-in-out !important;
        }
        
        button {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 40px;
            min-height: 40px;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        #score-container {
            text-align: center;
            margin: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        #score-container ul {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 0;
            flex-wrap: wrap;
        }
        
        header {
            text-align: center;
            padding: 20px;
        }
        
        header h1 {
            color: #ffcc00;
            margin: 0;
        }
        
        #controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        #game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            border: 2px solid #ffcc00;
        }
        
        #game-over.hidden {
            display: none;
        }
        
        .initialization-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #ffcc00;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 999;
            max-width: 300px;
        }
        
        .error-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            color: #ff6b6b;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            text-align: center;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <!-- Initialization status indicator -->
    <div id="init-status" class="initialization-status">
        üîÑ Initializing...
    </div>
    
    <!-- Header section -->
    <header>
        <div class="container">
            <h1 class="game-title">Fancy 2048</h1>
            <nav aria-label="Game controls">
                <ul id="controls-container" class="controls" role="menubar">
                    <li role="none">
                        <button type="button" id="changeColor-button" aria-label="Change Color" data-tooltip="Change game colors">
                            <i class="fas fa-palette" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="leaderboard-button" aria-label="View Statistics" onclick="window.location.href='leaderboard.html'" data-tooltip="View statistics and leaderboard">
                            <i class="fas fa-chart-line" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="back-button" aria-label="Undo Move" data-tooltip="Undo last move">
                            <i class="fas fa-undo" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="pause-button" aria-label="Pause Game" data-tooltip="Pause/Resume game">
                            <i class="fas fa-pause" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="board-size-button" aria-label="Change Board Size" data-tooltip="Change board size">
                            <i class="fas fa-th" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="theme-toggle-button" aria-label="Toggle Theme" data-tooltip="Toggle light/dark theme">
                            <i class="fas fa-adjust" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="autoplay-button" aria-label="Auto Play" data-tooltip="Start/Stop auto play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="speed-button" aria-label="Autoplay Speed" data-tooltip="Change autoplay speed">
                            <span class="speed-text">1x</span>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="reset-button" aria-label="Reset Game" data-tooltip="Start a new game">
                            <i class="fas fa-redo" aria-hidden="true"></i>
                        </button>
                    </li>
                    <li role="none">
                        <button type="button" id="ai-difficulty-button" aria-label="Change AI Difficulty" data-tooltip="Change AI difficulty level">
                            <i class="fas fa-brain" aria-hidden="true"></i>
                            <span class="button-text">Normal</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main content section -->
    <main id="main-content">
        <section class="game-section">
            <div id="board-container" class="board-container" role="grid" aria-label="Game Board" tabindex="0"></div>
            <div id="game-over" class="hidden" role="alert" aria-live="assertive">Game Over!</div>
        </section>

        <aside id="score-container" aria-labelledby="score-title">
            <h2 id="score-title" class="visually-hidden">Score Information</h2>
            <ul>
                <li>Score: <span id="score">0</span></li>
                <li>Best: <span id="best-score">0</span></li>
                <li>Moves: <span id="moves">0</span></li>
                <li>Time: <span id="time">00:00</span></li>
            </ul>
        </aside>
    </main>

    <!-- Enhanced JavaScript loading with comprehensive error handling -->
    <script>
        // Enhanced initialization system with comprehensive error handling
        console.log('üöÄ Starting Fancy2048 Enhanced Initialization...');
        
        let initStatus = document.getElementById('init-status');
        let initSteps = [];
        let errors = [];
        
        function updateInitStatus(message, isError = false) {
            console.log(message);
            initSteps.push(message);
            if (initStatus) {
                initStatus.innerHTML = isError ? `‚ùå ${message}` : `üîÑ ${message}`;
                if (isError) {
                    initStatus.style.background = 'rgba(244, 67, 54, 0.8)';
                    initStatus.style.color = '#ffffff';
                }
            }
        }
        
        function showCriticalError(title, message, technical = '') {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <div>
                    <h2>üö® ${title}</h2>
                    <p style="margin: 20px 0;">${message}</p>
                    ${technical ? `<details style="margin: 20px 0; text-align: left;"><summary>Technical Details</summary><pre style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 12px;">${technical}</pre></details>` : ''}
                    <button onclick="location.reload()" style="padding: 12px 24px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px;">
                        üîÑ Retry
                    </button>
                    <button onclick="window.location.href='simple_initialization_test.html'" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px;">
                        üß™ Run Diagnostics
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
        }
        
        // Global error handlers
        window.addEventListener('error', (event) => {
            const error = `${event.error?.name || 'Error'}: ${event.error?.message || event.message}`;
            errors.push(error);
            updateInitStatus(`Script error: ${error}`, true);
            
            if (event.filename && event.filename.includes('game.js')) {
                showCriticalError(
                    'Game Script Error',
                    'The main game script failed to load or execute properly.',
                    `${error}\nFile: ${event.filename}:${event.lineno}`
                );
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            const error = `Promise rejection: ${event.reason}`;
            errors.push(error);
            updateInitStatus(error, true);
        });
        
        // DOM readiness check
        function waitForDOM() {
            return new Promise((resolve) => {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', resolve);
                } else {
                    resolve();
                }
            });
        }
        
        // Script loading tracker
        let scriptsToLoad = 3;
        let scriptsLoaded = 0;
        let scriptErrors = 0;
        
        function onScriptLoad(scriptName) {
            scriptsLoaded++;
            updateInitStatus(`‚úÖ ${scriptName} loaded (${scriptsLoaded}/${scriptsToLoad})`);
            
            if (scriptsLoaded === scriptsToLoad) {
                setTimeout(initializeGame, 100); // Small delay to ensure everything is ready
            }
        }
        
        function onScriptError(scriptName, error) {
            scriptErrors++;
            const errorMsg = `‚ùå Failed to load ${scriptName}`;
            errors.push(errorMsg);
            updateInitStatus(errorMsg, true);
            
            // Continue with initialization even if some scripts fail
            scriptsLoaded++; // Count as "loaded" to continue
            if (scriptsLoaded === scriptsToLoad) {
                setTimeout(initializeGame, 100);
            }
        }
        
        async function initializeGame() {
            try {
                updateInitStatus('üéÆ Starting game initialization...');
                
                // Wait for DOM to be ready
                await waitForDOM();
                updateInitStatus('‚úÖ DOM ready');
                
                // Verify required DOM elements
                const requiredElements = ['board-container', 'score', 'best-score', 'moves', 'time'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    throw new Error(`Missing DOM elements: ${missingElements.join(', ')}`);
                }
                updateInitStatus('‚úÖ All DOM elements found');
                
                // Check if Game class is available
                if (typeof Game === 'undefined') {
                    throw new Error('Game class not loaded - check game.js script');
                }
                updateInitStatus('‚úÖ Game class available');
                
                // Create game instance
                updateInitStatus('üé≤ Creating game instance...');
                window.game = new Game(4);
                updateInitStatus('‚úÖ Game instance created');
                
                // Verify game is working
                if (!window.game.board || !Array.isArray(window.game.board)) {
                    throw new Error('Game board not properly initialized');
                }
                updateInitStatus('‚úÖ Game board verified');
                
                // Test a basic method
                const canMoveUp = window.game.canMove('up');
                updateInitStatus('‚úÖ Game methods working');
                
                // Hide initialization status after success
                setTimeout(() => {
                    if (initStatus) {
                        initStatus.style.opacity = '0';
                        setTimeout(() => {
                            if (initStatus && initStatus.parentNode) {
                                initStatus.parentNode.removeChild(initStatus);
                            }
                        }, 500);
                    }
                }, 2000);
                
                updateInitStatus('üéâ Initialization complete!');
                console.log('üéâ Fancy2048 initialization completed successfully!');
                
                // Optional: Show brief success message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(76, 175, 80, 0.9); color: white; padding: 12px 20px;
                    border-radius: 25px; font-weight: bold; z-index: 999;
                    animation: slideInTop 0.3s ease-out;
                `;
                successMsg.textContent = 'üéÆ Game Ready!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.style.animation = 'fadeOut 0.5s ease-in forwards';
                    setTimeout(() => successMsg.remove(), 500);
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Game initialization failed:', error);
                updateInitStatus('‚ùå Initialization failed', true);
                
                showCriticalError(
                    'Initialization Failed',
                    'The game could not be initialized properly. This might be due to missing files or browser compatibility issues.',
                    `${error.message}\n\nSteps completed: ${initSteps.join(' ‚Üí ')}\nErrors: ${errors.join(', ')}`
                );
            }
        }
        
        // Start loading scripts
        updateInitStatus('üì¶ Loading scripts...');
    </script>
    
    <!-- Load scripts with enhanced error handling -->
    <script 
        src="../scripts/advanced_ai_solver.js"
        onload="onScriptLoad('Advanced AI Solver')"
        onerror="onScriptError('Advanced AI Solver', event)">
    </script>
    
    <script 
        src="../scripts/enhanced_ai.js"
        onload="onScriptLoad('Enhanced AI')"
        onerror="onScriptError('Enhanced AI', event)">
    </script>
    
    <script 
        src="../scripts/game.js"
        onload="onScriptLoad('Game Engine')"
        onerror="onScriptError('Game Engine', event)">
    </script>
    
    <!-- Fallback initialization -->
    <script>
        // Fallback initialization if scripts don't load properly
        setTimeout(() => {
            if (!window.game && scriptsLoaded < scriptsToLoad) {
                updateInitStatus('‚è∞ Script loading timeout - attempting fallback...', true);
                
                // Try to initialize anyway if Game class exists
                if (typeof Game !== 'undefined') {
                    try {
                        window.game = new Game(4);
                        updateInitStatus('‚úÖ Fallback initialization successful');
                        
                        if (initStatus) {
                            initStatus.style.background = 'rgba(76, 175, 80, 0.8)';
                            setTimeout(() => {
                                initStatus.style.opacity = '0';
                                setTimeout(() => initStatus.remove(), 500);
                            }, 2000);
                        }
                    } catch (fallbackError) {
                        showCriticalError(
                            'Complete Initialization Failure',
                            'Both normal and fallback initialization failed.',
                            fallbackError.message
                        );
                    }
                } else {
                    showCriticalError(
                        'Script Loading Timeout',
                        'Game scripts failed to load within the expected time. This might be due to network issues or file corruption.',
                        `Scripts loaded: ${scriptsLoaded}/${scriptsToLoad}\nErrors: ${errors.join(', ')}`
                    );
                }
            }
        }, 5000); // 5 second timeout
    </script>
    
    <!-- Additional CSS animations -->
    <style>
        @keyframes slideInTop {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideOutTop {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100%); opacity: 0; }
        }
    </style>
</body>
</html>
