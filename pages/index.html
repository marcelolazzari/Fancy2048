<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#1a1a1a" />
  <meta name="apple-mobile-web-app-title" content="Fancy2048" />
  <title>Fancy 2048</title>
  <meta name="description" content="Play Fancy 2048, a modern twist on the classic puzzle game. Track your stats and compete on the leaderboard!" />
  <!-- Primary CSS -->
  <link rel="stylesheet" href="../styles/main.css" />
  <!-- Fallback CSS for GitHub Pages -->
  <link rel="stylesheet" href="/Fancy2048/styles/main.css" onerror="this.onerror=null;this.href='styles/main.css';" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Fallback styles to ensure basic layout if CSS fails to load -->
  <style>
    :root {
      --size: 4;
      --tile-size: 1fr;
      --gap: 10px;
      --board-bg: #333;
      --tile-bg: #666;
    }
    /* Remove problematic inline styles - use main.css responsive system instead */
    body {
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    
    /* Let the responsive CSS system handle board sizing */
    #board-container {
      margin: 20px auto !important;
    }
    
    /* Basic button styling */
    button { 
      background: #ffcc00; 
      color: #000; 
      border: none; 
      padding: 10px 15px; 
      margin: 5px; 
      border-radius: 5px; 
      cursor: pointer; 
    }
    
    /* Score container styling */
    #score-container { 
      text-align: center; 
      margin: 20px; 
    }
    
    #score-container ul { 
      list-style: none; 
      padding: 0; 
      display: flex; 
      justify-content: center; 
      gap: 20px; 
    }
    
    /* Header styling */
    header { 
      text-align: center; 
      padding: 20px; 
    }
    header h1 { color: #ffcc00; margin: 0; }
  </style>
  </head>
  <body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header section -->
    <header>
      <div class="container">
        <h1 class="game-title" tabindex="0">Fancy 2048</h1>
        
        <!-- Mobile hamburger button -->
        <button type="button" id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobile-controls-menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <!-- Mobile overlay menu -->
        <div id="mobile-controls-menu" class="mobile-controls-menu" aria-hidden="true">
          <div class="mobile-menu-header">
            <h2>Game Controls</h2>
            <button type="button" id="mobile-menu-close" class="mobile-menu-close" aria-label="Close menu">
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>
          <div class="mobile-menu-content">
            <div class="mobile-menu-section">
              <h3>Game Actions</h3>
              <div class="mobile-button-group">
                <button type="button" id="mobile-pause-button" class="mobile-menu-button" aria-label="Pause Game">
                  <i class="fas fa-pause" aria-hidden="true"></i>
                  <span>Pause</span>
                </button>
                <button type="button" id="mobile-back-button" class="mobile-menu-button" aria-label="Undo Move">
                  <i class="fas fa-undo" aria-hidden="true"></i>
                  <span>Undo</span>
                </button>
                <button type="button" id="mobile-reset-button" class="mobile-menu-button" aria-label="Reset Game">
                  <i class="fas fa-redo" aria-hidden="true"></i>
                  <span>Reset</span>
                </button>
              </div>
            </div>
            
            <div class="mobile-menu-section">
              <h3>Game Settings</h3>
              <div class="mobile-button-group">
                <button type="button" id="mobile-board-size-button" class="mobile-menu-button" aria-label="Change Board Size">
                  <i class="fas fa-th" aria-hidden="true"></i>
                  <span>Board Size</span>
                </button>
                <button type="button" id="mobile-theme-toggle-button" class="mobile-menu-button" aria-label="Toggle Theme">
                  <i class="fas fa-adjust" aria-hidden="true"></i>
                  <span>Theme</span>
                </button>
                <button type="button" id="mobile-changeColor-button" class="mobile-menu-button" aria-label="Change Color">
                  <i class="fas fa-palette" aria-hidden="true"></i>
                  <span>Colors</span>
                </button>
              </div>
            </div>
            
            <div class="mobile-menu-section">
              <h3>AI Controls</h3>
              <div class="mobile-button-group">
                <button type="button" id="mobile-autoplay-button" class="mobile-menu-button" aria-label="Auto Play">
                  <i class="fas fa-play" aria-hidden="true"></i>
                  <span>Auto Play</span>
                </button>
                <button type="button" id="mobile-speed-button" class="mobile-menu-button" aria-label="Autoplay Speed">
                  <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                  <span class="speed-text">Speed: 1x</span>
                </button>
                <button type="button" id="mobile-ai-difficulty-button" class="mobile-menu-button" aria-label="Change AI Difficulty">
                  <i class="fas fa-brain" aria-hidden="true"></i>
                  <span class="button-text">AI: Normal</span>
                </button>
              </div>
            </div>
            
            <div class="mobile-menu-section">
              <h3>Statistics</h3>
              <div class="mobile-button-group">
                <button type="button" id="mobile-leaderboard-button" class="mobile-menu-button" aria-label="View Statistics" onclick="window.location.href='leaderboard.html'">
                  <i class="fas fa-chart-line" aria-hidden="true"></i>
                  <span>Statistics</span>
                </button>
                <button type="button" id="mobile-export-stats-button" class="mobile-menu-button" aria-label="Export Statistics">
                  <i class="fas fa-download" aria-hidden="true"></i>
                  <span>Export</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Desktop navigation (hidden on mobile) -->
        <nav aria-label="Game controls" class="desktop-nav">
          <ul id="controls-container" class="controls" role="menubar">
            <li role="none">
              <button type="button" id="changeColor-button" aria-label="Change Color" tabindex="0" role="menuitem" data-tooltip="Change game colors">
                <i class="fas fa-palette" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="leaderboard-button" aria-label="View Statistics" onclick="window.location.href='leaderboard.html'" tabindex="0" role="menuitem" data-tooltip="View statistics and leaderboard">
                <i class="fas fa-chart-line" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="export-stats-button" aria-label="Export Statistics" tabindex="0" role="menuitem" data-tooltip="Export game statistics to JSON">
                <i class="fas fa-download" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="back-button" aria-label="Undo Move" tabindex="0" role="menuitem" data-tooltip="Undo last move">
                <i class="fas fa-undo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="pause-button" aria-label="Pause Game" tabindex="0" role="menuitem" data-tooltip="Pause/Resume game">
                <i class="fas fa-pause" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="board-size-button" aria-label="Change Board Size" tabindex="0" role="menuitem" data-tooltip="Change board size">
                <i class="fas fa-th" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="theme-toggle-button" aria-label="Toggle Theme" tabindex="0" role="menuitem" data-tooltip="Toggle light/dark theme">
                <i class="fas fa-adjust" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="autoplay-button" aria-label="Auto Play" tabindex="0" role="menuitem" data-tooltip="Start/Stop auto play">
                <i class="fas fa-play" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="speed-button" aria-label="Autoplay Speed" tabindex="0" role="menuitem" data-tooltip="Change autoplay speed">
                <span class="speed-text">1x</span>
              </button>
            </li>
            <li role="none">
              <button type="button" id="reset-button" aria-label="Reset Game" tabindex="0" role="menuitem" data-tooltip="Start a new game">
                <i class="fas fa-redo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="ai-difficulty-button" aria-label="Change AI Difficulty" tabindex="0" role="menuitem" data-tooltip="Change AI difficulty level">
                <i class="fas fa-brain" aria-hidden="true"></i>
                <span class="button-text">Normal</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main content section -->
    <main id="main-content">
      <div class="overlay" aria-hidden="true"></div>
      <section class="game-section">
  <div id="board-container" class="board-container" role="grid" aria-label="Game Board" tabindex="0"></div>
  <div id="game-over" class="hidden" role="alert" aria-live="assertive">Game Over!</div>
      </section>

      <aside id="score-container" aria-labelledby="score-title">
        <h2 id="score-title" class="visually-hidden">Score Information</h2>
        <ul>
          <li>Score: <span id="score">0</span></li>
          <li>Best: <span id="best-score">0</span></li>
          <li>Moves: <span id="moves">0</span></li>
          <li>Time: <span id="time">00:00</span></li>
        </ul>
      </aside>
    </main>

    <!-- Footer section -->
    <footer>
      <div class="container">
        <!-- Reset button moved to navigation menu -->
      </div>
    </footer>

    <!-- JavaScript files - loaded in specific order for proper initialization -->
    <script>
      // Pre-initialization debugging
      console.log('🚀 Starting Fancy2048 script loading...');
      console.log('Document ready state:', document.readyState);
      console.log('Current URL:', window.location.href);
      console.log('Base URL:', window.location.origin);
      console.log('DOM elements check:', {
        boardContainer: !!document.getElementById('board-container'),
        scoreContainer: !!document.getElementById('score-container'),
        score: !!document.getElementById('score'),
        bestScore: !!document.getElementById('best-score')
      });
      
      // Global error handler
      window.addEventListener('error', (event) => {
        console.error('🚨 Global error:', event.error);
        console.error('File:', event.filename, 'Line:', event.lineno, 'Column:', event.colno);
      });
      
      // Unhandled promise rejection handler
      window.addEventListener('unhandledrejection', (event) => {
        console.error('🚨 Unhandled promise rejection:', event.reason);
      });
      
      // Function to load script with fallback paths
      function loadScript(primarySrc, fallbackSrc, name) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = primarySrc;
          script.onerror = () => {
            console.warn(`⚠️ Failed to load ${name} from ${primarySrc}, trying fallback...`);
            if (fallbackSrc) {
              const fallbackScript = document.createElement('script');
              fallbackScript.src = fallbackSrc;
              fallbackScript.onload = () => {
                console.log(`✅ Loaded ${name} from fallback: ${fallbackSrc}`);
                resolve();
              };
              fallbackScript.onerror = () => {
                console.error(`❌ Failed to load ${name} from both paths`);
                reject(new Error(`Failed to load ${name}`));
              };
              document.head.appendChild(fallbackScript);
            } else {
              console.error(`❌ Failed to load ${name}`);
              reject(new Error(`Failed to load ${name}`));
            }
          };
          script.onload = () => {
            console.log(`✅ Loaded ${name} from: ${primarySrc}`);
            resolve();
          };
          document.head.appendChild(script);
        });
      }
      
      // Load scripts sequentially with fallback support
      async function loadAllScripts() {
        try {
          // Load enhanced core components first
          await loadScript('../scripts/game_core.js', '/Fancy2048/scripts/game_core.js', 'game_core.js');
          await loadScript('../scripts/enhanced_ai_core.js', '/Fancy2048/scripts/enhanced_ai_core.js', 'enhanced_ai_core.js');
          await loadScript('../scripts/game_over_manager.js', '/Fancy2048/scripts/game_over_manager.js', 'game_over_manager.js');
          
          // Load original components
          await loadScript('../scripts/ai_learning_system.js', '/Fancy2048/scripts/ai_learning_system.js', 'ai_learning_system.js');
          await loadScript('../scripts/advanced_ai_solver.js', '/Fancy2048/scripts/advanced_ai_solver.js', 'advanced_ai_solver.js');
          await loadScript('../scripts/enhanced_ai.js', '/Fancy2048/scripts/enhanced_ai.js', 'enhanced_ai.js');
          
          // Load original game engine
          await loadScript('../scripts/game.js', '/Fancy2048/scripts/game.js', 'game.js');
          
          // Load enhanced integration layer
          await loadScript('../scripts/enhanced_game_integration.js', '/Fancy2048/scripts/enhanced_game_integration.js', 'enhanced_game_integration.js');
          
          console.log('✅ All enhanced scripts loaded successfully');
          
          // Initialize enhanced game after all scripts are loaded
          if (typeof EnhancedGame !== 'undefined') {
            console.log('🚀 Initializing Enhanced Game...');
            window.game = new EnhancedGame(4);
            console.log('✅ Enhanced Game initialized successfully');
          } else {
            console.warn('⚠️ EnhancedGame not available, using original Game');
            if (typeof Game !== 'undefined') {
              window.game = new Game(4);
            }
          }
        } catch (error) {
          console.error('❌ Script loading failed:', error);
          // Show user-friendly error
          document.body.innerHTML += `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); color: #ff6b6b; display: flex; align-items: center; justify-content: center; z-index: 10000; text-align: center; font-family: Arial;">
              <div>
                <h2>🚨 Game Loading Error</h2>
                <p>Failed to load game scripts. Please refresh the page.</p>
                <p style="font-size: 0.9em; opacity: 0.8;">Error: ${error.message}</p>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">Refresh Page</button>
              </div>
            </div>
          `;
        }
      }
      
      // Start loading scripts
      loadAllScripts();
    </script>
  </body>
</html>