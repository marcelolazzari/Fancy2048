<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Basic meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    
    <!-- SEO and description meta tags -->
    <meta name="description" content="Play Fancy 2048 - A beautiful, feature-rich version of the classic 2048 puzzle game with themes, animations, and enhanced gameplay." />
    <meta name="keywords" content="2048, puzzle game, tile game, number game, brain game, fancy 2048, sliding puzzle, math game" />
    <meta name="author" content="Marcelo Lazzari" />
    <meta name="robots" content="index, follow" />
    <meta name="generator" content="Fancy 2048 Game Engine" />
    <link rel="canonical" href="https://marcelolazzari.github.io/Fancy2048/" />
    
    <!-- Open Graph meta tags for social sharing -->
    <meta property="og:title" content="Fancy 2048 - Enhanced Puzzle Game" />
    <meta property="og:description" content="Play the most beautiful version of 2048 with themes, animations, and enhanced features." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://marcelolazzari.github.io/Fancy2048/" />
    <meta property="og:image" content="https://marcelolazzari.github.io/Fancy2048/images/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Fancy 2048" />
    <meta property="og:locale" content="en_US" />
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Fancy 2048 - Enhanced Puzzle Game" />
    <meta name="twitter:description" content="Play the most beautiful version of 2048 with themes, animations, and enhanced features." />
    <meta name="twitter:image" content="https://marcelolazzari.github.io/Fancy2048/images/twitter-card.png" />
    <meta name="twitter:image:alt" content="Fancy 2048 game screenshot showing colorful tiles on a game board" />
    <meta name="twitter:creator" content="@marcelolazzari" />
    
    <!-- PWA and mobile app meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Fancy 2048" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#faf8ef" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    <meta name="msapplication-TileColor" content="#faf8ef" />
    <meta name="msapplication-TileImage" content="../images/mstile-144x144.png" />
    <meta name="application-name" content="Fancy 2048" />
    
    <!-- Security and privacy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), interest-cohort=()" />
    
    <title>Fancy 2048 - Enhanced Puzzle Game | Play Online</title>
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="../styles/unified_styles.css" as="style" />
    <link rel="preload" href="../scripts/game.js" as="script" />
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" crossorigin="anonymous" />
    
    <!-- Stylesheets with improved loading -->
    <link rel="stylesheet" href="../styles/unified_styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json" />
    
    <!-- Enhanced favicon set -->
    <link rel="icon" type="image/x-icon" href="../favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png" />
    <link rel="mask-icon" href="../images/safari-pinned-tab.svg" color="#faf8ef" />
    
    <!-- Critical CSS inlined for faster first paint -->
    <style>
      /* Critical CSS for loading state */
      .loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #faf8ef;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #bbada0;
        border-top: 4px solid #8f7a66;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Accessibility utilities */
      .visually-hidden, .visually-hidden-focusable:not(:focus):not(:focus-within) {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }
    </style>
    
    <!-- Structured data for rich results -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Fancy 2048",
      "description": "A beautiful, feature-rich version of the classic 2048 puzzle game with themes, animations, and enhanced gameplay.",
      "url": "https://marcelolazzari.github.io/Fancy2048/",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "creator": {
        "@type": "Person",
        "name": "Marcelo Lazzari"
      },
      "datePublished": "2024-01-01",
      "inLanguage": "en",
      "browserRequirements": "Requires JavaScript. Works with modern browsers."
    }
    </script>
  </head>
  
  <body>
    <!-- Skip navigation for accessibility -->
    <a href="#main-content" class="skip-link visually-hidden-focusable" tabindex="1">Skip to main content</a>
    
    <!-- Loading indicator with improved accessibility -->
    <div id="loading-indicator" class="loading-indicator" aria-live="polite" aria-label="Loading game" role="status">
      <div class="loading-spinner" aria-hidden="true"></div>
      <span id="loading-text">Loading Fancy 2048...</span>
    </div>
    
    <!-- Header section with game controls -->
    <header role="banner">
      <div class="container">
        <h1 class="game-title">
          <span class="game-name">Fancy 2048</span>
          <span class="game-subtitle visually-hidden">Enhanced puzzle game</span>
        </h1>
        
        <!-- Game controls navigation with improved structure -->
        <nav role="navigation" aria-label="Game controls and settings">
          <ul id="controls-container" class="controls" role="toolbar" aria-label="Game action buttons">
            <li>
              <button type="button" id="changeColor-button" class="control-btn" aria-label="Change color theme" title="Change Color Theme" aria-describedby="color-theme-description">
                <i class="fas fa-palette" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Color</span>
              </button>
              <div id="color-theme-description" class="visually-hidden">Cycle through different color themes for the game board</div>
            </li>
            <li>
              <button type="button" id="leaderboard-button" class="control-btn" aria-label="View statistics and leaderboard" title="Statistics" data-href="leaderboard.html">
                <i class="fas fa-chart-line" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Stats</span>
              </button>
            </li>
            <li>
              <button type="button" id="rainbowMode-button" class="control-btn" aria-label="Toggle rainbow mode animation" title="Rainbow Mode" aria-pressed="false">
                <i class="fas fa-rainbow" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Rainbow</span>
              </button>
            </li>
            <li>
              <button type="button" id="back-button" class="control-btn" aria-label="Undo last move" title="Undo Move (Ctrl+Z)" aria-keyshortcuts="Ctrl+Z">
                <i class="fas fa-undo" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Undo</span>
              </button>
            </li>
            <li>
              <button type="button" id="pause-button" class="control-btn" aria-label="Pause or resume game" title="Pause Game (Spacebar)" aria-keyshortcuts="Space" aria-pressed="false">
                <i class="fas fa-pause" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Pause</span>
              </button>
            </li>
            <li>
              <button type="button" id="board-size-button" class="control-btn" aria-label="Change board size" title="Board Size" aria-describedby="board-size-description">
                <i class="fas fa-th" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Size</span>
              </button>
              <div id="board-size-description" class="visually-hidden">Toggle between different board sizes: 3x3, 4x4, 5x5, and 6x6</div>
            </li>
            <li>
              <button type="button" id="theme-toggle-button" class="control-btn" aria-label="Toggle light and dark theme" title="Toggle Theme" aria-pressed="false">
                <i class="fas fa-adjust" aria-hidden="true"></i>
                <span class="btn-label visually-hidden">Theme</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main game content -->
    <main id="main-content" role="main" tabindex="-1">
      <!-- Overlay for paused state or modals -->
      <div id="overlay" class="overlay" aria-hidden="true" inert></div>
      
      <!-- Game board section -->
      <section class="game-section" aria-labelledby="game-board-title">
        <h2 id="game-board-title" class="visually-hidden">2048 Game Board</h2>
        
        <!-- Game board container with enhanced accessibility -->
        <div id="board-container" class="board-container" 
             role="grid" 
             aria-label="Game board with numbered tiles. Use arrow keys, WASD, or swipe to move tiles."
             tabindex="0"
             aria-describedby="game-instructions current-board-state"
             aria-rowcount="4"
             aria-colcount="4">
        </div>
        
        <!-- Live region for game state announcements -->
        <div id="current-board-state" class="visually-hidden" aria-live="polite" aria-atomic="false"></div>
        <div id="game-announcements" class="visually-hidden" aria-live="assertive" aria-atomic="true"></div>
        
        <!-- Game over notification -->
        <div id="game-over" class="game-over hidden" role="dialog" aria-live="assertive" aria-labelledby="game-over-title" aria-modal="true">
          <h3 id="game-over-title">Game Over!</h3>
          <p id="final-score-message" aria-live="polite"></p>
          <div class="game-over-actions">
            <button type="button" id="play-again-btn" class="btn btn-primary" autofocus>Play Again</button>
            <button type="button" id="view-stats-btn" class="btn btn-secondary">View Statistics</button>
          </div>
        </div>
        
        <!-- Game won notification -->
        <div id="game-won" class="game-won hidden" role="dialog" aria-live="assertive" aria-labelledby="game-won-title" aria-modal="true">
          <h3 id="game-won-title">Congratulations!</h3>
          <p>You reached 2048! Continue playing or start a new game.</p>
          <div class="win-actions">
            <button type="button" id="continue-btn" class="btn btn-secondary" autofocus>Continue</button>
            <button type="button" id="new-game-btn" class="btn btn-primary">New Game</button>
          </div>
        </div>
        
        <!-- Pause overlay -->
        <div id="pause-overlay" class="pause-overlay hidden" role="dialog" aria-live="polite" aria-labelledby="pause-title" aria-modal="true">
          <h3 id="pause-title">Game Paused</h3>
          <p>Press spacebar or click the pause button to resume</p>
          <button type="button" id="resume-btn" class="btn btn-primary" autofocus>Resume Game</button>
        </div>
      </section>

      <!-- Game statistics sidebar with improved structure -->
      <aside id="score-container" class="score-panel" role="complementary" aria-labelledby="score-title">
        <h2 id="score-title">Game Statistics</h2>
        <div class="score-grid" role="group" aria-labelledby="score-title">
          <div class="score-item">
            <div class="score-label" id="current-score-label">Current Score</div>
            <div id="score" class="score-value" aria-live="polite" aria-labelledby="current-score-label" role="status">0</div>
          </div>
          <div class="score-item">
            <div class="score-label" id="best-score-label">Best Score</div>
            <div id="best-score" class="score-value" aria-labelledby="best-score-label">0</div>
          </div>
          <div class="score-item">
            <div class="score-label" id="moves-label">Moves</div>
            <div id="moves" class="score-value" aria-live="polite" aria-labelledby="moves-label" role="status">0</div>
          </div>
          <div class="score-item">
            <div class="score-label" id="time-label">Time</div>
            <div id="time" class="score-value" aria-live="polite" aria-labelledby="time-label" role="timer">00:00</div>
          </div>
        </div>
      </aside>
      
      <!-- Enhanced game instructions -->
      <div id="game-instructions" class="visually-hidden">
        <h3>How to Play Fancy 2048</h3>
        <p>Use arrow keys, WASD keys, or swipe gestures to move tiles. When two tiles with the same number touch, they merge into one tile with double the value. The goal is to reach the 2048 tile!</p>
        <h4>Keyboard Shortcuts:</h4>
        <ul>
          <li>Arrow keys or WASD: Move tiles</li>
          <li>Spacebar: Pause/Resume game</li>
          <li>Ctrl+Z: Undo last move</li>
          <li>R: Restart game</li>
          <li>Escape: Close dialogs</li>
        </ul>
        <h4>Touch Controls:</h4>
        <ul>
          <li>Swipe up, down, left, or right to move tiles</li>
          <li>Tap control buttons for additional features</li>
        </ul>
      </div>
    </main>

    <!-- Footer with enhanced accessibility -->
    <footer role="contentinfo">
      <div class="container">
        <div class="footer-content">
          <button type="button" id="reset-button" class="btn btn-danger" aria-label="Reset game and start over" aria-describedby="reset-warning">
            <i class="fas fa-refresh" aria-hidden="true"></i>
            Reset Game
          </button>
          <div id="reset-warning" class="visually-hidden">Warning: This will delete your current progress and start a new game</div>
          
          <!-- Additional footer information -->
          <div class="footer-info">
            <p class="copyright">© 2024 Fancy 2048 by Marcelo Lazzari</p>
            <div class="footer-links">
              <button type="button" id="help-button" class="link-btn" aria-label="Show game help and instructions">Help</button>
              <button type="button" id="about-button" class="link-btn" aria-label="About this game and developer">About</button>
              <button type="button" id="accessibility-button" class="link-btn" aria-label="Accessibility options">Accessibility</button>
            </div>
          </div>
        </div>
      </div>
    </footer>
    
    <!-- Enhanced error boundary -->
    <div id="error-boundary" class="error-boundary hidden" role="alert" aria-live="assertive">
      <h3>Oops! Something went wrong</h3>
      <p id="error-message">An unexpected error occurred. Please refresh the page to continue playing.</p>
      <div class="error-actions">
        <button type="button" id="reload-button" class="btn btn-primary">
          <i class="fas fa-refresh" aria-hidden="true"></i>
          Reload Game
        </button>
        <button type="button" id="report-error-button" class="btn btn-secondary">
          <i class="fas fa-bug" aria-hidden="true"></i>
          Report Issue
        </button>
      </div>
    </div>

    <!-- Accessibility announcements -->
    <div id="accessibility-announcements" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <!-- Enhanced JavaScript with better error handling and performance -->
    <script>
      // Performance monitoring
      const performanceObserver = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (entry.entryType === 'navigation') {
            console.log('Page load time:', entry.loadEventEnd - entry.fetchStart, 'ms');
          }
        }
      });
      performanceObserver.observe({ entryTypes: ['navigation'] });

      // Enhanced Service Worker registration
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        window.addEventListener('load', async function() {
          try {
            const registration = await navigator.serviceWorker.register('../sw.js', {
              scope: '../',
              updateViaCache: 'imports'
            });
            
            console.log('ServiceWorker registration successful with scope:', registration.scope);
            
            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New content available
                  showUpdateAvailable();
                }
              });
            });
          } catch (err) {
            console.warn('ServiceWorker registration failed:', err);
          }
        });
      }
      
      // Enhanced error handling with user feedback
      window.addEventListener('error', function(e) {
        console.error('Global error:', e);
        handleError(e.message, e.filename, e.lineno, e.colno, e.error);
      });
      
      window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e);
        handleError('Promise rejection: ' + e.reason, '', 0, 0, e.reason);
      });
      
      function handleError(message, source, lineno, colno, error) {
        const errorBoundary = document.getElementById('error-boundary');
        const errorMessage = document.getElementById('error-message');
        
        if (errorBoundary && errorMessage) {
          errorMessage.textContent = `Error: ${message}`;
          if (source && lineno) {
            errorMessage.textContent += ` (${source}:${lineno})`;
          }
          errorBoundary.classList.remove('hidden');
          
          // Announce error to screen readers
          announceToScreenReader(`An error occurred: ${message}. You can reload the game or report the issue.`);
        }
        
        // Send error to analytics (if implemented)
        if (typeof gtag !== 'undefined') {
          gtag('event', 'exception', {
            description: message,
            fatal: false
          });
        }
      }
      
      // Enhanced loading state management
      window.addEventListener('DOMContentLoaded', function() {
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        
        if (loadingIndicator) {
          // Simulate progressive loading
          setTimeout(() => {
            if (loadingText) loadingText.textContent = 'Initializing game...';
          }, 500);
          
          setTimeout(() => {
            if (loadingText) loadingText.textContent = 'Almost ready...';
          }, 1000);
          
          // Hide loading indicator when everything is ready
          setTimeout(() => {
            loadingIndicator.style.opacity = '0';
            setTimeout(() => {
              loadingIndicator.style.display = 'none';
              announceToScreenReader('Fancy 2048 game loaded successfully. Use arrow keys or swipe to play.');
              
              // Focus the game board for keyboard users
              const boardContainer = document.getElementById('board-container');
              if (boardContainer) {
                boardContainer.focus();
              }
            }, 300);
          }, 1500);
        }
      });
      
      // Accessibility helper functions
      function announceToScreenReader(message) {
        const announcements = document.getElementById('accessibility-announcements');
        if (announcements) {
          announcements.textContent = message;
          // Clear after announcement
          setTimeout(() => {
            announcements.textContent = '';
          }, 1000);
        }
      }
      
      function showUpdateAvailable() {
        // Create and show update notification
        const updateBanner = document.createElement('div');
        updateBanner.className = 'update-banner';
        updateBanner.innerHTML = `
          <p>A new version is available!</p>
          <button onclick="location.reload()" class="btn btn-small">Update Now</button>
          <button onclick="this.parentElement.remove()" class="btn btn-small btn-secondary">Later</button>
        `;
        document.body.insertBefore(updateBanner, document.body.firstChild);
      }
      
      // Enhanced navigation handling
      document.getElementById('leaderboard-button')?.addEventListener('click', function(e) {
        e.preventDefault();
        const href = this.getAttribute('data-href');
        if (href) {
          window.location.href = href;
        }
      });
      
      // Keyboard navigation improvements
      document.addEventListener('keydown', function(e) {
        // Global keyboard shortcuts
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          document.getElementById('back-button')?.click();
        } else if (e.key === ' ' || e.key === 'Spacebar') {
          if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            document.getElementById('pause-button')?.click();
          }
        } else if (e.key === 'r' || e.key === 'R') {
          if (e.target.tagName !== 'INPUT') {
            e.preventDefault();
            if (confirm('Are you sure you want to restart the game?')) {
              document.getElementById('reset-button')?.click();
            }
          }
        } else if (e.key === 'Escape') {
          // Close any open dialogs
          const openDialogs = document.querySelectorAll('[role="dialog"]:not(.hidden)');
          openDialogs.forEach(dialog => {
            const continueBtn = dialog.querySelector('#continue-btn, #resume-btn');
            continueBtn?.click();
          });
        }
      });
      
      // Focus management for dialogs
      function trapFocus(element) {
        const focusableElements = element.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        element.addEventListener('keydown', function(e) {
          if (e.key === 'Tab') {
            if (e.shiftKey) {
              if (document.activeElement === firstFocusable) {
                lastFocusable.focus();
                e.preventDefault();
              }
            } else {
              if (document.activeElement === lastFocusable) {
                firstFocusable.focus();
                e.preventDefault();
              }
            }
          }
        });
      }
      
      // Apply focus trapping to dialogs when they're shown
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.getAttribute('role') === 'dialog' && !target.classList.contains('hidden')) {
              trapFocus(target);
            }
          }
        });
      });
      
      document.querySelectorAll('[role="dialog"]').forEach(dialog => {
        observer.observe(dialog, { attributes: true });
      });
    </script>
    <script src="../scripts/game.js" defer></script>
  </body>
</html>