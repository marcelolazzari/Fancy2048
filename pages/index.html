<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#1a1a1a" />
  <meta name="apple-mobile-web-app-title" content="Fancy2048" />
  <meta name="msapplication-TileColor" content="#1a1a1a" />
  <meta name="msapplication-TileImage" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23ffcc00' width='100' height='100' rx='10'/><text x='50' y='60' text-anchor='middle' font-family='Arial,sans-serif' font-size='24' font-weight='bold' fill='%23000'>2048</text></svg>" />
  
  <title>Fancy 2048</title>
  <meta name="description" content="Play Fancy 2048, a modern twist on the classic puzzle game. Track your stats and compete on the leaderboard!" />
  <meta name="keywords" content="2048, puzzle game, brain training, mobile game, AI assistant" />
  <meta name="author" content="Fancy2048" />
  
  <!-- Performance: Preload critical resources -->
  <link rel="preload" href="../styles/main.css" as="style" />
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
  
  <!-- Primary CSS with GitHub Pages support -->
  <link rel="stylesheet" href="../styles/main.css" />
  <!-- Fallback CSS for GitHub Pages -->
  <link rel="stylesheet" href="/Fancy2048/styles/main.css" onerror="this.onerror=null;this.href='../styles/main.css';" />
  <!-- Additional fallback for direct access -->
  <link rel="stylesheet" href="styles/main.css" onerror="this.remove();" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" />
  <!-- Fallback styles to ensure basic layout if CSS fails to load -->
  <style>
    :root {
      --size: 4;
      --tile-size: 1fr;
      --gap: 10px;
      --board-bg: #333;
      --tile-bg: #666;
    }
    /* Remove problematic inline styles - use main.css responsive system instead */
    body {
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    
    /* Let the responsive CSS system handle board sizing */
    #board-container {
      margin: 20px auto !important;
    }
    
    /* Basic button styling */
    button { 
      background: #ffcc00; 
      color: #000; 
      border: none; 
      padding: 10px 15px; 
      margin: 5px; 
      border-radius: 5px; 
      cursor: pointer; 
    }
    
    /* Score container styling */
    #score-container { 
      text-align: center; 
      margin: 20px; 
    }
    
    #score-container ul { 
      list-style: none; 
      padding: 0; 
      display: flex; 
      justify-content: center; 
      gap: 20px; 
    }
    
    /* Header styling */
    header { 
      text-align: center; 
      padding: 20px; 
    }
    header h1 { color: #ffcc00; margin: 0; }
  </style>
  </head>
  <body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header section -->
    <header>
      <div class="container">
        <h1 class="game-title" tabindex="0">Fancy 2048</h1>
        <nav aria-label="Game controls">
          <ul id="controls-container" class="controls" role="menubar">
            <li role="none">
              <button type="button" id="changeColor-button" aria-label="Change Color" tabindex="0" role="menuitem" data-tooltip="Change game colors">
                <i class="fas fa-palette" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="leaderboard-button" aria-label="View Statistics" onclick="navigateToLeaderboard()" tabindex="0" role="menuitem" data-tooltip="View statistics and leaderboard">
                <i class="fas fa-chart-line" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="export-stats-button" aria-label="Export Statistics" tabindex="0" role="menuitem" data-tooltip="Export game statistics to JSON">
                <i class="fas fa-download" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="back-button" aria-label="Undo Move" tabindex="0" role="menuitem" data-tooltip="Undo last move">
                <i class="fas fa-undo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="pause-button" aria-label="Pause Game" tabindex="0" role="menuitem" data-tooltip="Pause/Resume game">
                <i class="fas fa-pause" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="board-size-button" aria-label="Change Board Size" tabindex="0" role="menuitem" data-tooltip="Change board size">
                <i class="fas fa-th" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="theme-toggle-button" aria-label="Toggle Theme" tabindex="0" role="menuitem" data-tooltip="Toggle light/dark theme">
                <i class="fas fa-adjust" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="autoplay-button" aria-label="Auto Play" tabindex="0" role="menuitem" data-tooltip="Start/Stop auto play">
                <i class="fas fa-play" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="speed-button" aria-label="Autoplay Speed" tabindex="0" role="menuitem" data-tooltip="Change autoplay speed">
                <span class="speed-text">1x</span>
              </button>
            </li>
            <li role="none">
              <button type="button" id="reset-button" aria-label="Reset Game" tabindex="0" role="menuitem" data-tooltip="Start a new game">
                <i class="fas fa-redo" aria-hidden="true"></i>
              </button>
            </li>
            <li role="none">
              <button type="button" id="ai-difficulty-button" aria-label="Change AI Difficulty" tabindex="0" role="menuitem" data-tooltip="Change AI difficulty level">
                <i class="fas fa-brain" aria-hidden="true"></i>
                <span class="button-text">Normal</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main content section -->
    <main id="main-content">
      <!-- Game status messages -->
      <div id="game-over" class="message-overlay hidden" role="alert" aria-live="assertive">
        <div class="message-content">
          <h2>Game Over!</h2>
          <p>No more moves possible.</p>
          <div class="message-buttons">
            <button onclick="window.game?.resetGame()" class="restart-button">Try Again</button>
            <button onclick="navigateToLeaderboard()" class="stats-button">View Stats</button>
          </div>
        </div>
      </div>
      
      <div id="game-won" class="message-overlay hidden" role="alert" aria-live="assertive">
        <div class="message-content">
          <h2>You Won!</h2>
          <p>You reached 2048!</p>
          <div class="message-buttons">
            <button onclick="window.game?.continueGame()" class="continue-button">Continue Playing</button>
            <button onclick="window.game?.resetGame()" class="restart-button">New Game</button>
          </div>
        </div>
      </div>
      
      <div id="pause-overlay" class="overlay hidden" role="alert" aria-live="polite">
        <div class="overlay-content">
          <h2>Game Paused</h2>
          <p>Press Space or click Resume to continue</p>
          <button onclick="window.game?.togglePause()" class="resume-button">Resume</button>
        </div>
      </div>

      <section class="game-section">
        <div id="board-container" class="board-container" role="grid" aria-label="Game Board" tabindex="0"></div>
      </section>

      <aside id="score-container" aria-labelledby="score-title">
        <h2 id="score-title" class="visually-hidden">Score Information</h2>
        <ul>
          <li>Score: <span id="score">0</span></li>
          <li>Best: <span id="best-score">0</span></li>
          <li>Moves: <span id="moves">0</span></li>
          <li>Time: <span id="time">00:00</span></li>
        </ul>
      </aside>
    </main>

    <!-- Footer section -->
    <footer>
      <div class="container">
        <!-- Reset button moved to navigation menu -->
      </div>
    </footer>

    <!-- JavaScript files - simplified and robust loading -->
    <script>
      // Pre-initialization debugging
      console.log('🚀 Starting Fancy2048 script loading...');
      console.log('Document ready state:', document.readyState);
      
      // Global error handler
      window.addEventListener('error', (event) => {
        console.error('🚨 Global error:', event.error);
        console.error('File:', event.filename, 'Line:', event.lineno, 'Column:', event.colno);
      });
      
      // Unhandled promise rejection handler
      window.addEventListener('unhandledrejection', (event) => {
        console.error('🚨 Unhandled promise rejection:', event.reason);
      });
      
      // Global game variable
      let game = null;
      
      // Robust initialization function
      function initializeFancy2048() {
        try {
          console.log('🎮 Initializing game...');
          
          // Check for required DOM elements
          const requiredElements = ['board-container', 'score', 'best-score', 'moves', 'time'];
          const missingElements = requiredElements.filter(id => !document.getElementById(id));
          
          if (missingElements.length > 0) {
            throw new Error(`Missing required DOM elements: ${missingElements.join(', ')}`);
          }
          
          // Check for Game class
          if (typeof Game === 'undefined') {
            throw new Error('Game class not found - scripts may not have loaded properly');
          }
          
          // Initialize the game
          game = new Game(4);
          window.game = game; // Make globally accessible
          
          console.log('✅ Game initialized successfully');
          
          // Setup additional controls
          setupGameControls();
          
        } catch (error) {
          console.error('❌ Game initialization failed:', error);
          showGameError(error.message);
        }
      }
      
      function setupGameControls() {
        // Keyboard controls
        document.addEventListener('keydown', (event) => {
          if (!game || game.isPaused) return;
          
          switch (event.key) {
            case 'ArrowUp':
              event.preventDefault();
              game.move('up');
              break;
            case 'ArrowDown':
              event.preventDefault();
              game.move('down');
              break;
            case 'ArrowLeft':
              event.preventDefault();
              game.move('left');
              break;
            case 'ArrowRight':
              event.preventDefault();
              game.move('right');
              break;
            case ' ':
              event.preventDefault();
              game.togglePause();
              break;
          }
        });
      }
      
        function showGameError(message) {
          const boardContainer = document.getElementById('board-container');
          if (boardContainer) {
            boardContainer.innerHTML = `
              <div style="
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                height: 100%; 
                text-align: center; 
                color: #ff6b6b;
                padding: 20px;
              ">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                <h3 style="margin: 0 0 10px 0; color: #ff6b6b;">Game Loading Error</h3>
                <p style="margin: 0 0 20px 0;">${message}</p>
                <button onclick="location.reload()" style="
                  background: #ff6b6b; 
                  color: white; 
                  border: none; 
                  padding: 10px 20px; 
                  border-radius: 5px; 
                  cursor: pointer;
                  font-size: 16px;
                ">
                  <i class="fas fa-redo"></i> Reload Game
                </button>
              </div>
            `;
          }
        }
        
        // Navigation helper for GitHub Pages
        function navigateToLeaderboard() {
          // Try multiple possible paths for GitHub Pages
          const possiblePaths = [
            'leaderboard.html',
            '/Fancy2048/pages/leaderboard.html',
            '../pages/leaderboard.html'
          ];
          
          // Use the first path as default
          window.location.href = possiblePaths[0];
        }        // Load scripts sequentially
        function loadScript(src, name) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => {
              console.log(`✅ Loaded: ${name}`);
              resolve();
            };
            script.onerror = () => {
              console.error(`❌ Failed to load: ${name}`);
              reject(new Error(`Failed to load ${name}`));
            };
            document.head.appendChild(script);
          });
        }
        
        // Load all scripts with GitHub Pages support
        async function loadGameScripts() {
          try {
            console.log('📦 Loading game scripts...');
            
            // Try multiple path patterns for each script
            const scripts = [
              { name: 'AI Learning System', paths: ['../scripts/ai_learning_system.js', '/Fancy2048/scripts/ai_learning_system.js', 'scripts/ai_learning_system.js'] },
              { name: 'Advanced AI Solver', paths: ['../scripts/advanced_ai_solver.js', '/Fancy2048/scripts/advanced_ai_solver.js', 'scripts/advanced_ai_solver.js'] },
              { name: 'Enhanced AI', paths: ['../scripts/enhanced_ai.js', '/Fancy2048/scripts/enhanced_ai.js', 'scripts/enhanced_ai.js'] },
              { name: 'Game Engine', paths: ['../scripts/game.js', '/Fancy2048/scripts/game.js', 'scripts/game.js'] }
            ];
            
            for (const script of scripts) {
              let loaded = false;
              for (const path of script.paths) {
                try {
                  await loadScript(path, script.name);
                  loaded = true;
                  break;
                } catch (error) {
                  console.warn(`Failed to load ${script.name} from ${path}, trying next...`);
                }
              }
              if (!loaded) {
                throw new Error(`Failed to load ${script.name} from all paths`);
              }
            }
            
            console.log('📦 All scripts loaded successfully');
            
            // Initialize game after a short delay to ensure everything is ready
            setTimeout(initializeFancy2048, 100);
            
          } catch (error) {
            console.error('❌ Script loading failed:', error);
            showGameError('Failed to load game scripts. Please refresh the page.');
          }
        }      // Start loading when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGameScripts);
      } else {
        loadGameScripts();
      }
    </script>
  </body>
</html>