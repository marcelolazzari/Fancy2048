<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fancy2048 Autoplay Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .controls { margin: 20px 0; }
        button { 
            padding: 12px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        #game-area {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        #game-board {
            width: 300px;
            height: 300px;
            background: #bbada0;
            border-radius: 6px;
            position: relative;
            padding: 10px;
        }
        .tile {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #cdc1b4;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.15s ease-in-out;
        }
        .game-info {
            flex: 1;
        }
        .score-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .score-item {
            background: #bbada0;
            color: white;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
            min-width: 80px;
        }
        .score-label {
            font-size: 12px;
            text-transform: uppercase;
        }
        .score-value {
            font-size: 24px;
            font-weight: bold;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .active { background: #28a745 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 Fancy2048 Autoplay Diagnostic Tool</h1>
        
        <div id="initialization-status" class="status info">
            🔄 Initializing application...
        </div>

        <div class="controls">
            <button id="btn-test-classes" class="btn-primary">Test Classes</button>
            <button id="btn-test-ai" class="btn-warning">Test AI</button>
            <button id="btn-start-autoplay" class="btn-success">Start Autoplay</button>
            <button id="btn-stop-autoplay" class="btn-danger">Stop Autoplay</button>
            <button id="btn-new-game" class="btn-primary">New Game</button>
            <button id="btn-clear-log" class="btn-warning">Clear Log</button>
        </div>

        <div id="game-area">
            <div id="game-board"></div>
            <div class="game-info">
                <div class="score-panel">
                    <div class="score-item">
                        <div class="score-label">Score</div>
                        <div id="current-score" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Best</div>
                        <div id="best-score" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Moves</div>
                        <div id="move-count" class="score-value">0</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="ai-auto" class="btn-success">Auto Play</button>
                    <button id="ai-hint" class="btn-primary">Get Hint</button>
                    <select id="ai-difficulty">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="expert">Expert</option>
                    </select>
                </div>
            </div>
        </div>

        <h3>📋 Diagnostic Log</h3>
        <div class="log-container">
            <div id="log"></div>
        </div>
    </div>

    <!-- Load all game scripts -->
    <script src="src/js/error-handler.js"></script>
    <script src="src/js/utils.js"></script>
    <script src="src/js/storage.js"></script>
    <script src="src/js/ai-solver.js"></script>
    <script src="src/js/touch-handler.js"></script>
    <script src="src/js/game-engine.js"></script>
    <script src="src/js/ui-controller.js"></script>
    <script src="src/js/app.js"></script>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> [${++logCount}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('initialization-status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function testClasses() {
            log('🔍 Testing class availability...', 'info');
            
            const classes = [
                'Utils', 'Storage', 'GameEngine', 'AISolver', 
                'UIController', 'TouchHandler', 'Fancy2048App'
            ];
            
            let allAvailable = true;
            
            for (const className of classes) {
                if (typeof window[className] !== 'undefined') {
                    log(`✅ ${className} is available`, 'success');
                } else {
                    log(`❌ ${className} is NOT available`, 'error');
                    allAvailable = false;
                }
            }
            
            if (allAvailable) {
                log('🎉 All classes are available!', 'success');
            } else {
                log('⚠️ Some classes are missing - check script loading order', 'warning');
            }
        }

        function testAI() {
            log('🤖 Testing AI functionality...', 'info');
            
            if (!window.fancy2048App) {
                log('❌ App instance not found', 'error');
                return;
            }
            
            const app = window.fancy2048App;
            
            log(`📊 App Status:`, 'info');
            log(`   - Initialized: ${app.isInitialized}`, 'info');
            log(`   - Has GameEngine: ${!!app.gameEngine}`, 'info');
            log(`   - Has AISolver: ${!!app.aiSolver}`, 'info');
            log(`   - Game Over: ${app.gameEngine ? app.gameEngine.isGameOver : 'N/A'}`, 'info');
            log(`   - Current Score: ${app.gameEngine ? app.gameEngine.score : 'N/A'}`, 'info');
            
            if (!app.aiSolver) {
                log('❌ AI Solver not available', 'error');
                return;
            }
            
            log('🎯 Testing AI move generation...', 'info');
            app.aiSolver.getBestMove().then(move => {
                if (move) {
                    log(`✅ AI suggested move: ${move}`, 'success');
                } else {
                    log('⚠️ AI returned no move (possibly game over or no valid moves)', 'warning');
                }
            }).catch(error => {
                log(`❌ AI move generation failed: ${error.message}`, 'error');
            });
        }

        function startAutoplay() {
            log('🚀 Starting autoplay...', 'info');
            
            if (!window.fancy2048App || !window.fancy2048App.aiSolver) {
                log('❌ Cannot start autoplay - app or AI not available', 'error');
                return;
            }
            
            const app = window.fancy2048App;
            
            if (app.autoPlayActive) {
                log('⚠️ Autoplay is already active', 'warning');
                return;
            }
            
            app.startAutoPlay().then(result => {
                if (result) {
                    log('✅ Autoplay started successfully!', 'success');
                    document.getElementById('btn-start-autoplay').textContent = 'Autoplay Active';
                    document.getElementById('btn-start-autoplay').disabled = true;
                    document.getElementById('btn-stop-autoplay').disabled = false;
                    
                    // Monitor autoplay
                    const monitor = setInterval(() => {
                        if (!app.autoPlayActive) {
                            clearInterval(monitor);
                            log('🛑 Autoplay stopped', 'info');
                            document.getElementById('btn-start-autoplay').textContent = 'Start Autoplay';
                            document.getElementById('btn-start-autoplay').disabled = false;
                            document.getElementById('btn-stop-autoplay').disabled = true;
                        } else {
                            log(`📈 Score: ${app.gameEngine.score}, Moves: ${app.gameEngine.moves}`, 'info');
                        }
                    }, 1000);
                    
                } else {
                    log('❌ Autoplay failed to start', 'error');
                }
            }).catch(error => {
                log(`❌ Autoplay start error: ${error.message}`, 'error');
            });
        }

        function stopAutoplay() {
            log('🛑 Stopping autoplay...', 'info');
            
            if (!window.fancy2048App) {
                log('❌ App not available', 'error');
                return;
            }
            
            window.fancy2048App.stopAutoPlay();
            log('✅ Autoplay stopped', 'success');
            
            document.getElementById('btn-start-autoplay').textContent = 'Start Autoplay';
            document.getElementById('btn-start-autoplay').disabled = false;
            document.getElementById('btn-stop-autoplay').disabled = true;
        }

        function newGame() {
            log('🎮 Starting new game...', 'info');
            
            if (!window.fancy2048App) {
                log('❌ App not available', 'error');
                return;
            }
            
            window.fancy2048App.newGame();
            log('✅ New game started', 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('📄 DOM loaded', 'info');
            
            // Button event listeners
            document.getElementById('btn-test-classes').addEventListener('click', testClasses);
            document.getElementById('btn-test-ai').addEventListener('click', testAI);
            document.getElementById('btn-start-autoplay').addEventListener('click', startAutoplay);
            document.getElementById('btn-stop-autoplay').addEventListener('click', stopAutoplay);
            document.getElementById('btn-new-game').addEventListener('click', newGame);
            document.getElementById('btn-clear-log').addEventListener('click', () => {
                document.getElementById('log').innerHTML = '';
                logCount = 0;
            });
            
            // AI button from the game
            const aiButton = document.getElementById('ai-auto');
            if (aiButton) {
                aiButton.addEventListener('click', () => {
                    log('🔘 AI Auto button clicked', 'info');
                    if (window.fancy2048App && window.fancy2048App.autoPlayActive) {
                        stopAutoplay();
                    } else {
                        startAutoplay();
                    }
                });
            }
        });

        // Wait for app initialization
        window.addEventListener('load', () => {
            log('🌐 Window loaded', 'info');
            
            // Check for app every 500ms
            let checkCount = 0;
            const checkApp = setInterval(() => {
                checkCount++;
                
                if (window.fancy2048App) {
                    clearInterval(checkApp);
                    log('🎉 App instance found!', 'success');
                    updateStatus('✅ Application initialized successfully', 'success');
                    
                    // Run initial tests
                    setTimeout(() => {
                        testClasses();
                        testAI();
                    }, 500);
                    
                } else if (checkCount > 20) { // Stop after 10 seconds
                    clearInterval(checkApp);
                    log('❌ App initialization timeout', 'error');
                    updateStatus('❌ Application failed to initialize', 'error');
                } else {
                    log(`⏳ Waiting for app initialization... (${checkCount}/20)`, 'warning');
                }
            }, 500);
        });

        // Capture console errors
        window.addEventListener('error', (event) => {
            log(`💥 JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            log(`🚫 Unhandled Promise Rejection: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
