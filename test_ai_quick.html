<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Quick AI Game Over Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #f2f2f2;
        }
        button {
            padding: 15px 25px;
            margin: 10px;
            background: #ffcc00;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #e6b800;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .pass { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; }
        .fail { background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; }
        .info { background: rgba(0, 170, 255, 0.2); border: 1px solid #00aaff; }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #ffcc00;
            border-radius: 8px;
            margin: 20px 0;
        }
        pre {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>üß™ Quick AI Game Over Test</h1>
    
    <div class="status info">
        <h3>üéØ Test Purpose</h3>
        <p>This test verifies that AI properly detects game over conditions by setting up a nearly full board and letting AI play until it reaches game over.</p>
    </div>
    
    <button onclick="runQuickTest()">üöÄ Run Quick AI Test</button>
    <button onclick="forceGameOver()">üíÄ Force Game Over Scenario</button>
    <button onclick="clearLog()">üßπ Clear Log</button>
    
    <div id="testResults"></div>
    
    <iframe id="gameFrame" src="pages/index.html"></iframe>
    
    <div class="status info">
        <h3>üìä Test Log</h3>
        <pre id="testLog">Test ready to begin...</pre>
    </div>
    
    <script>
        let testLog = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog += `[${timestamp}] ${message}\\n`;
            document.getElementById('testLog').textContent = testLog;
            console.log(message);
        }
        
        function clearLog() {
            testLog = '';
            document.getElementById('testLog').textContent = 'Log cleared...';
        }
        
        async function runQuickTest() {
            log('üöÄ Starting Quick AI Game Over Test');
            
            const gameFrame = document.getElementById('gameFrame');
            
            // Wait for game to load
            await new Promise(resolve => {
                const checkLoad = () => {
                    try {
                        const game = gameFrame.contentWindow.game;
                        if (game && game.board) {
                            resolve();
                            return;
                        }
                    } catch (e) {}
                    setTimeout(checkLoad, 100);
                };
                checkLoad();
            });
            
            const game = gameFrame.contentWindow.game;
            log('‚úÖ Game loaded successfully');
            
            // Enable debug mode
            gameFrame.contentWindow.debugAI = true;
            log('üîß Debug mode enabled');
            
            // Set up a nearly full board to speed up the test
            game.board = [
                [2, 4, 8, 16],
                [32, 64, 128, 256],
                [512, 1024, 2, 4],
                [8, 16, 32, 0]  // One empty space remaining
            ];
            game.updateUI();
            log('üé≤ Set up nearly full board for quick testing');
            
            // Start AI at max speed
            game.currentSpeedIndex = game.speedMultipliers.length - 1;
            game.startAutoPlay();
            log('ü§ñ AI autoplay started at MAX speed');
            
            // Monitor for game over
            let moves = 0;
            const startTime = Date.now();
            
            const monitor = setInterval(() => {
                try {
                    const currentMoves = game.moves;
                    const gameState = game.gameState;
                    const isAIRunning = game.isAutoPlaying;
                    
                    if (currentMoves !== moves) {
                        moves = currentMoves;
                        log(`üéÆ AI Move ${moves}: Score ${game.score}, State: ${gameState}`);
                    }
                    
                    if (gameState === 'over') {
                        clearInterval(monitor);
                        const elapsed = (Date.now() - startTime) / 1000;
                        
                        if (!isAIRunning) {
                            log('‚úÖ SUCCESS: Game over detected and AI stopped properly!');
                            log(`üìä Test completed in ${elapsed.toFixed(1)}s with ${moves} moves`);
                            
                            document.getElementById('testResults').innerHTML = `
                                <div class="status pass">
                                    <h3>‚úÖ TEST PASSED</h3>
                                    <p>AI successfully detected game over and stopped autoplay.</p>
                                    <ul>
                                        <li>Final Score: ${game.score.toLocaleString()}</li>
                                        <li>Total Moves: ${moves}</li>
                                        <li>Time: ${elapsed.toFixed(1)} seconds</li>
                                        <li>AI Status: Properly stopped</li>
                                    </ul>
                                </div>
                            `;
                        } else {
                            log('‚ùå FAILURE: Game over detected but AI did not stop!');
                            
                            document.getElementById('testResults').innerHTML = `
                                <div class="status fail">
                                    <h3>‚ùå TEST FAILED</h3>
                                    <p>AI detected game over but did not stop autoplay properly.</p>
                                    <p>This indicates an issue with AI termination logic.</p>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Timeout after 30 seconds
                    if (elapsed > 30) {
                        clearInterval(monitor);
                        log('‚ö†Ô∏è Test timed out - AI may not be reaching game over');
                        
                        document.getElementById('testResults').innerHTML = `
                            <div class="status fail">
                                <h3>‚ö†Ô∏è TEST TIMEOUT</h3>
                                <p>Test ran for 30 seconds without reaching game over.</p>
                                <p>AI may be performing too well or there may be an issue with game over detection.</p>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    log('‚ùå Error during monitoring: ' + error.message);
                    clearInterval(monitor);
                }
            }, 100);
            
        }
        
        async function forceGameOver() {
            log('üíÄ Setting up forced game over scenario');
            
            const gameFrame = document.getElementById('gameFrame');
            
            try {
                const game = gameFrame.contentWindow.game;
                if (!game) {
                    log('‚ùå Game not loaded');
                    return;
                }
                
                // Set up a board with no possible moves
                game.board = [
                    [2, 4, 2, 4],
                    [4, 2, 4, 2],
                    [2, 4, 2, 4],
                    [4, 2, 4, 2]
                ];
                game.updateUI();
                log('üé≤ Set up impossible board configuration');
                
                // Enable debug mode
                gameFrame.contentWindow.debugAI = true;
                
                // Try to start AI
                game.startAutoPlay();
                log('ü§ñ Attempting to start AI on impossible board');
                
                // Check AI response
                setTimeout(() => {
                    const isRunning = game.isAutoPlaying;
                    const gameState = game.gameState;
                    
                    if (gameState === 'over' && !isRunning) {
                        log('‚úÖ SUCCESS: AI immediately detected impossible board and set game over');
                        document.getElementById('testResults').innerHTML = `
                            <div class="status pass">
                                <h3>‚úÖ FORCED GAME OVER TEST PASSED</h3>
                                <p>AI correctly detected impossible board state immediately.</p>
                            </div>
                        `;
                    } else if (isRunning) {
                        log('‚ùå FAILURE: AI is still running on impossible board');
                        document.getElementById('testResults').innerHTML = `
                            <div class="status fail">
                                <h3>‚ùå FORCED GAME OVER TEST FAILED</h3>
                                <p>AI started running despite no moves being possible.</p>
                            </div>
                        `;
                    } else {
                        log('‚ö†Ô∏è Unclear result - checking game state...');
                        log(`Game state: ${gameState}, AI running: ${isRunning}`);
                    }
                }, 500);
                
            } catch (error) {
                log('‚ùå Error during forced game over test: ' + error.message);
            }
        }
        
        window.addEventListener('load', () => {
            log('üß™ Quick AI Game Over Test initialized');
            log('üéØ Click "Run Quick AI Test" to verify AI game over detection');
        });
    </script>
</body>
</html>
